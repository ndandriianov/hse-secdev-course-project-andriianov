# ADR-001: Формат ошибок по стандарту RFC 7807

**Дата:** 2025-11-02
**Статус:** Accepted

## Context

В системе OKR Tracker необходимо обеспечить **унифицированный и безопасный** формат ответов об ошибках. Текущие проблемы:

- **Раскрытие внутренней структуры** через информативные сообщения об ошибках (риск **R7** из RISKS.md).
- Отсутствие стандартизированного формата усложняет обработку ошибок на клиенте.
- Угроза **Information Disclosure (I)** из STRIDE-анализа (элементы F8, P3).

Рассматривались варианты:
1. **Собственный формат** — гибкость, но отсутствие совместимости.
2. **RFC 7807 (Problem Details for HTTP APIs)** — индустриальный стандарт, структурированный JSON.
3. **GraphQL-стиль errors** — избыточно для REST API.

Ограничения:
- Ответы НЕ должны раскрывать стектрейсы, внутренние имена классов или SQL-запросы.
- Необходима трассируемость ошибок через `correlation_id`.

## Decision

Принят **RFC 7807** как единый формат для всех HTTP-ошибок (4xx, 5xx).

```json
{
  "type": "https://api.okr.example.com/probs/validation-error",
  "title": "Unprocessable Entity",
  "status": 422,
  "detail": "period_name must be provided",
  "instance": "/objectives",
  "errors": {
    "period_name": ["must be provided"]
  }
}
```

**Параметры:**
- `type`: URI, идентифицирующий тип проблемы (например, `https://api.okr.example.com/probs/...`).
- `title`: Краткое название HTTP-статуса (например, `Bad Request`, `Not Found`).
- `status`: HTTP-статус код.
- `detail`: Человекочитаемое описание конкретной ошибки (без технических деталей).
- `instance`: URI текущего запроса (для контекста).
- `errors`: Структурированные ошибки валидации (опционально, для 4xx).
- `correlation_id` — **добавляется на уровне middleware** (вне scope текущей реализации, но запланирован).

**Реализация:**
- Кастомное исключение `ProblemException` + глобальный обработчик в `main.py`.
- Все `HTTPException` заменены на `ProblemException` с предопределёнными `type`-URI.
- 401 от `OAuth2PasswordBearer` перехватывается через `@app.exception_handler(HTTPException)`.
- `Content-Type: application/problem+json`.

## Consequences

**Плюсы:**
- Снижает риск **R7** — нет утечек внутренней структуры.
- Все ошибки — в стандарте RFC 7807, `application/problem+json`.
- `type`-URI позволяют клиентам различать ошибки программно.
- Легко расширяемо под `correlation_id` и логирование.

**Минусы:**
- Требуется поддержка `PROBLEM_TYPES` в коде.
- 401-ошибки требуют отдельного обработчика (перехват `HTTPException`).

**Влияние:**
- **DX:** Улучшен — Swagger показывает RFC 7807-ошибки.
- **Безопасность:** Устранён риск раскрытия.
- **Тестирование:** Можно проверить через Swagger UI (`/docs`).

**Следующие шаги:**
- Добавить `correlation_id` через middleware.
- Добавить 500-обработчик с `internal-error` типом.
- Документировать все `type`-URI в OpenAPI.

## Links
- **NFR-3** (Аутентификация и авторизация)
- **NFR-6** (Аудит — логирование с `correlation_id`)
- **R7** (RISKS.md) — устранено
- **STRIDE:** Information Disclosure (I) — минимизировано
- **Критерий закрытия R7:** 100% ошибок — в формате RFC 7807, проверено в Swagger + тестами.
