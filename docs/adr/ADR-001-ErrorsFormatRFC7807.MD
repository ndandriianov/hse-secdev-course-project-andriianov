# ADR-001: Формат ошибок по стандарту RFC 7807

**Дата:** 2025-11-02
**Статус:** Accepted

## Context

В системе OKR Tracker необходимо обеспечить **унифицированный и безопасный** формат ответов об ошибках. Текущие проблемы:

- **Раскрытие внутренней структуры** через информативные сообщения об ошибках (риск **R7** из RISKS.md).
- Отсутствие стандартизированного формата усложняет обработку ошибок на клиенте.
- Угроза **Information Disclosure (I)** из STRIDE-анализа (элементы F8, P3).

Рассматривались варианты:
1. **Собственный формат** - гибкость, но отсутствие совместимости.
2. **RFC 7807 (Problem Details for HTTP APIs)** - индустриальный стандарт, структурированный JSON.
3. **GraphQL-стиль errors** - избыточно для REST API.

Ограничения:
- Ответы НЕ должны раскрывать стектрейсы, внутренние имена классов или SQL-запросы.
- Необходима трассируемость ошибок через `correlation_id`.

## Decision

Принят **RFC 7807** как единый формат для всех HTTP-ошибок (4xx, 5xx).

**Структура ответа:**
```json
{
  "type": "about:blank",
  "title": "Validation Error",
  "status": 400,
  "detail": "Invalid objective title: too short",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Параметры:**
- `type`: URI, идентифицирующий тип проблемы (по умолчанию `about:blank`).
- `title`: Краткое описание проблемы (не раскрывает внутреннюю логику).
- : HTTP-статус код. `status`
- `detail`: Описание конкретной ошибки (унифицированное, без технических деталей).
- `correlation_id`: UUID для трассировки запроса в логах.

**Реализация:**
- Middleware/exception handler в FastAPI перехватывает все исключения.
- Логирование полной информации (включая стектрейс) происходит на сервере с привязкой к `correlation_id`.
- Клиент получает только безопасную часть.

**Примеры:**

| Сценарий | HTTP Status | Title | Detail |
| --- | --- | --- | --- |
| Неверные учетные данные | 401 | Unauthorized | Invalid credentials |
| Брутфорс блокировка | 429 | Too Many Requests | Account temporarily locked |
| Валидация данных | 400 | Validation Error | Invalid field: progress must be 0-100 |
| Горизонтальная авторизация | 403 | Forbidden | Access denied |
| Внутренняя ошибка | 500 | Internal Server Error | An error occurred. Contact support with correlation_id |

## Consequences

**Плюсы:**
- Снижает риск **R7** (раскрытие внутренней структуры).
- Стандартизированный формат упрощает интеграцию с клиентами и мониторингом.
- `correlation_id` обеспечивает трассируемость для поддержки и отладки.
- Совместимость с индустрией (OpenAPI, спецификации API).

**Минусы:**
- Дополнительный код для middleware и валидации всех исключений.
- Требуется документирование допустимых `type` для каждого эндпоинта.

**Влияние:**
- **DX (Developer Experience):** Улучшается за счет стандартизации.
- **Производительность:** Минимальное - создание UUID и JSON-сериализация.
- **Стоимость:** Низкая - одноразовая реализация middleware.

## Links
- **NFR-3** (Аутентификация и авторизация)
- **NFR-6** (Аудит критичных операций - логирование correlation_id)
- **R7** (RISKS.md) - Раскрытие внутренней структуры через информативные сообщения об ошибках
- **STRIDE:** Угроза **Information Disclosure (I)** - элементы F8 (P1 -> E1), P3 (OKR Logic Service)
- **Критерий закрытия R7:** 100% API ответов об ошибках используют унифицированный формат RFC 7807 без раскрытия стектрейсов/внутренних деталей. Проверяется автоматическими тестами + код-ревью.
