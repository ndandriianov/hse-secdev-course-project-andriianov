# ADR-003: Управление секретами - источники, ротация, защита

Дата: 2025-11-02  
Статус: Accepted

## Context

Нужно быстро и просто обеспечить безопасную работу с секретами (JWT keys, DB passwords, API keys) в разработке и production, минимизируя риск утечек через репозиторий, логи и ответы API. Требуется простая, выполнимая политика без сложной инфраструктуры на старте.

## Decision

Принять минимальный набор правил и шагов, которые можно реализовать сразу:

1. Источник секретов  
- Dev/staging: переменные окружения (.env для локальной разработки). Файл .env должен быть в .gitignore (у нас уже есть .env.example).  
- Production: переменные окружения (CI/CD/оркестратор). В качестве улучшения - подключить внешнее хранилище (Vault/Secrets Manager) позже, но это не обязательное требование сейчас.

2. Запрет на хранение секретов в коде/репозитории  
- Никаких хардкоденных секретов в коде.  
- Добавить/включить pre-commit hook и CI-сканирование (gitleaks/semgrep настроены в проекте). Если ещё не включены - добавить базовую конфигурацию, которая блокирует коммит при обнаружении паттернов секретов.

3. Маскирование в логах и исключение в ответах  
- Логи: не печатать значения полей password/token/secret. Использовать SecretStr / не выводить raw env values.  
- API: секреты/ключи никогда не возвращать в теле ответа (ADR-001 обеспечивает безопасные ошибки).

4. Ротация и доступ (минимальный рабочий процесс)  
- Ротация: документировать, кто и как меняет секреты. На начальном этапе - ручная ротация (процесс в README/SECURITY.md), планировать автоматизацию (Vault) позже.  
- Доступ: принцип наименьших привилегий - сервисы получают только нужные переменные окружения.

5. CI/CD и тесты  
- CI проверяет отсутствие секретов (gitleaks/semgrep).  
- Тесты покрывают: нет хардкодов, логирование не содержит секретов.

## Implementation (конкретные шаги, минимально необходимые)

1. Проверка repo  
- Убедиться, что .env.example присутствует и .env в .gitignore.  

2. Pre-commit & CI  
- Включить/убедиться, что .gitleaks.toml и .semgrep.yaml активны в pre-commit и CI.  

3. Код  
- Использовать Pydantic SecretStr для полей типа password/token или при сериализации не выводить секреты.  
- В местах логирования: фильтровать ключи с именами password/token/secret.  

4. Документация  
- Добавить короткую инструкцию в README или SECURITY.md: как добавлять секреты локально и в production, как ротировать (ручной процесс).  

Примеры коротких проверок (для команды):  
- test_no_hardcoded_secrets - CI запуск gitleaks.  
- test_logs_mask_secrets - unit-test, который делает лог capture и проверяет отсутствие raw secret.

## Consequences

Плюсы:  
- Быстрая реализация с минимальными затратами.  
- Снижение высокой вероятности утечек через Git и логи.

Минусы:  
- Ротация и централизованное управление остаются ручными до внедрения Vault/Secrets Manager.  
- Не закрывает автоматическую ротацию и audit-level детализацию - это последующий шаг.

## Links

- NFR-5 (ротация секретов - требование; здесь: документировать и планировать ротацию)  
- NFR-6 (аудит - логирование доступа к секретам предполагается в будущем)  
- R6 (RISKS.md) - Утечка конфиденциальных данных (частично смягчается запретом хардкодов и маскированием логов)  
- R7 (RISKS.md) - Раскрытие через ошибки/логи (смягчение через маскирование и ADR-001)